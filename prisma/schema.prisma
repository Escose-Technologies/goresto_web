generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── ENUMS ──────────────────────────────────────────────

enum UserRole {
  superadmin
  restaurant_admin
}

enum DietaryType {
  veg
  non_veg
  egg
}

enum TableStatus {
  available
  occupied
  reserved
  maintenance
}

enum TableLocation {
  Indoor
  Outdoor
  VIP
  Bar
}

enum OrderStatus {
  pending
  accepted
  rejected
  on_hold
  preparing
  prepared
  ready
  served
  completed
  cancelled
}

enum StaffStatus {
  active
  inactive
  on_leave
}

enum Currency {
  USD
  EUR
  GBP
  INR
  CAD
  AUD
}

// ─── MODELS ─────────────────────────────────────────────

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  password      String
  role          UserRole
  restaurantId  String?
  restaurant    Restaurant?    @relation("UserRestaurant", fields: [restaurantId], references: [id], onDelete: SetNull)
  refreshTokens RefreshToken[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  adminOf       Restaurant[]   @relation("PrimaryAdmin")

  @@index([email])
  @@index([restaurantId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model Restaurant {
  id           String   @id @default(cuid())
  name         String
  description  String?
  address      String?
  phone        String?
  email        String?
  website      String?
  logo         String?  @db.Text
  coverImage   String?  @db.Text
  cuisineTypes String[]
  socialLinks  Json?
  openingHours String?
  discount     Json?
  qrCode       String?

  adminId String?
  admin   User?   @relation("PrimaryAdmin", fields: [adminId], references: [id], onDelete: SetNull)

  menuItems MenuItem[]
  tables    Table[]
  orders    Order[]
  staff     Staff[]
  settings  Settings?
  reviews   Review[]
  users     User[]     @relation("UserRestaurant")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([adminId])
}

model MenuItem {
  id           String      @id @default(cuid())
  restaurantId String
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  name         String
  price        Float
  description  String?
  category     String?
  image        String?     @db.Text
  available    Boolean     @default(true)
  dietaryType  DietaryType @default(veg)
  spiceLevel   Int         @default(0)
  allergens    String[]
  labels       String[]
  rating       Float       @default(0)
  reviewCount  Int         @default(0)

  reviews Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([restaurantId, category])
  @@index([restaurantId, available])
}

model Table {
  id           String        @id @default(cuid())
  restaurantId String
  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  number       String
  capacity     Int
  status       TableStatus   @default(available)
  location     TableLocation @default(Indoor)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([restaurantId, number])
  @@index([restaurantId])
}

model Order {
  id             String      @id @default(cuid())
  restaurantId   String
  restaurant     Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  tableNumber    String
  items          Json
  total          Float
  status         OrderStatus @default(pending)
  customerName   String?
  customerMobile String?
  notes          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([restaurantId, status])
  @@index([restaurantId, createdAt])
}

model Staff {
  id               String      @id @default(cuid())
  restaurantId     String
  restaurant       Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  name             String
  email            String
  phone            String
  role             String
  photo            String?     @db.Text
  hireDate         DateTime?
  status           StaffStatus @default(active)
  address          String?
  emergencyContact String?
  notes            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([restaurantId, email])
  @@index([restaurantId])
  @@index([restaurantId, status])
}

model Settings {
  id                     String   @id @default(cuid())
  restaurantId           String   @unique
  restaurant             Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  restaurantName         String?
  address                String?
  phone                  String?
  email                  String?
  currency               Currency @default(INR)
  openingTime            String?
  closingTime            String?
  primaryColor           String?  @default("#7C3AED")
  secondaryColor         String?  @default("#9333EA")
  timezone               String?  @default("Asia/Kolkata")
  taxRate                Float?   @default(0.08)
  serviceCharge          Float?   @default(0.1)
  allowOnlineOrders      Boolean  @default(true)
  allowTableReservations Boolean  @default(true)
  notificationEmail      String?
  discountText           String?
  kitchenPin             String?  @db.VarChar(4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id           String     @id @default(cuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItemId   String
  menuItem     MenuItem   @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  customerName String
  rating       Int
  comment      String?

  createdAt DateTime @default(now())

  @@index([restaurantId])
  @@index([menuItemId])
  @@index([restaurantId, menuItemId])
}
